<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Elements â€” Clawnads Admin</title>
  <link rel="icon" type="image/svg+xml" href="/clawnads-favicon-white.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=admin20">
  <link rel="stylesheet" href="/admin-nav.css">
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
    }
  }
  </script>
  <style>
    /* Fill screen for realistic viewport emulation */
    html, body { overflow: hidden; height: 100%; height: 100dvh; }

    /* Floating nav â€” matches sim.html and character/index.html */
    .admin-nav {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-nav-logo img { height: 18px; width: auto; opacity: 0.4; transition: opacity 0.2s; display: block; }
    .admin-nav-logo:hover img { opacity: 0.7; }
    .admin-nav-sep { color: #27272a; font-size: 12px; user-select: none; }
    .admin-nav-link { color: #71717a; text-decoration: none; font-size: 12px; font-weight: 500; transition: color 0.15s; }
    .admin-nav-link:hover { color: #fafafa; }
    .admin-nav-active { color: #a1a1aa; }

    /* Layout switcher â€” floats below nav */
    .page-controls {
      position: fixed;
      top: 46px;
      left: 16px;
      z-index: 100;
    }

    /* Sound button in toolbar */
    .sound-wrap {
      position: relative;
    }
    .sound-toggle {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      background: rgba(24, 24, 27, 0.85);
      border: 1px solid rgba(63, 63, 70, 0.5);
      color: var(--color-text-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .sound-toggle:hover { color: var(--color-text-primary); border-color: rgba(113, 113, 122, 0.5); }
    .sound-toggle.active { color: #22c55e; border-color: rgba(34, 197, 94, 0.3); }
    .sound-menu {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      min-width: 120px;
      background: rgba(24, 24, 27, 0.95);
      border: 1px solid rgba(63, 63, 70, 0.5);
      border-radius: 8px;
      padding: 4px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-4px);
      transition: all 0.15s ease;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .sound-menu.open { opacity: 1; visibility: visible; transform: translateY(0); }
    .sound-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 10px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: #a1a1aa;
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.12s;
      text-align: left;
    }
    .sound-menu-item:hover { background: rgba(63, 63, 70, 0.3); color: #fafafa; }
    .sound-menu-item.active { color: #22c55e; }
    .sound-menu-item .sm-icon { font-size: 14px; width: 18px; text-align: center; flex-shrink: 0; }
    .sound-menu-item .sm-label { flex: 1; }

    /* Orientation switcher */
    .orient-switch {
      display: flex;
      gap: 2px;
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      padding: 2px;
      border: 1px solid var(--color-border);
    }
    .orient-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 28px;
      border: none;
      border-radius: calc(var(--radius-lg) - 2px);
      background: transparent;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .orient-btn:hover { color: var(--color-text-secondary); }
    .orient-btn.active {
      background: var(--color-bg-elevated);
      color: var(--color-text-primary);
    }
    .orient-btn svg { pointer-events: none; }

    /* Sim viewport container */
    .sim-viewport-wrap {
      position: fixed;
      inset: 0;
      overflow: hidden;
      background: #09090b;
    }

    /* Canvas container fills the viewport wrap absolutely */
    .sim-viewport-wrap #canvas-container {
      position: absolute;
      inset: 0;
    }

    /* Landscape (default): full screen */
    .sim-viewport-wrap.landscape {
      inset: 0;
      transform: none;
      width: auto;
      height: auto;
      max-height: none;
    }

    /* Portrait: phone-like ratio, centered */
    .sim-viewport-wrap.portrait {
      inset: auto;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 390px;
      height: 100dvh;
      max-height: 844px;
    }

    .sim-viewport-wrap.fullscreen {
      inset: 0 !important;
      transform: none !important;
      z-index: 9999;
      border-radius: 0;
      border: none;
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
    }
    /* Hide floating overlays in fullscreen */
    body.is-fullscreen .admin-nav { display: none; }
    body.is-fullscreen .anav-profile { display: none; }
    body.is-fullscreen .page-controls { display: none; }

    /* Toolbar row â€” inside viewport wrap */
    .sim-toolbar {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sim-tool-btn {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      background: rgba(24, 24, 27, 0.85);
      border: 1px solid rgba(63, 63, 70, 0.5);
      color: var(--color-text-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .sim-tool-btn:hover {
      color: var(--color-text-primary);
      border-color: rgba(113, 113, 122, 0.5);
    }
    .sim-tool-btn svg { pointer-events: none; }

    /* Camera controller */
    .cam-ctrl {
      position: absolute;
      bottom: calc(24px + env(safe-area-inset-bottom, 0px));
      right: 24px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      user-select: none;
      -webkit-user-select: none;
    }
    .cam-top-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .cam-zoom-keys {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 2px;
      opacity: 0.4;
      transition: opacity 0.3s;
    }
    .cam-ctrl:hover .cam-zoom-keys { opacity: 0.65; }
    .cam-pad {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: rgba(24, 24, 27, 0.85);
      border: 1px solid rgba(63, 63, 70, 0.5);
      position: relative;
      touch-action: none;
      cursor: grab;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .cam-pad:active { cursor: grabbing; }
    .cam-pad-knob {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(113, 113, 122, 0.4);
      border: 1px solid rgba(113, 113, 122, 0.3);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      transition: background 0.15s;
    }
    .cam-pad.active .cam-pad-knob {
      background: rgba(34, 197, 94, 0.5);
      border-color: rgba(34, 197, 94, 0.4);
    }
    .cam-pad::before, .cam-pad::after {
      content: '';
      position: absolute;
      background: rgba(63, 63, 70, 0.3);
      pointer-events: none;
    }
    .cam-pad::before {
      width: 1px; height: 16px;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    .cam-pad::after {
      width: 16px; height: 1px;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    .cam-keys {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      opacity: 0.4;
      transition: opacity 0.3s;
    }
    .cam-ctrl:hover .cam-keys { opacity: 0.65; }
    .cam-keys-row { display: flex; gap: 2px; }
    .cam-key {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: rgba(24, 24, 27, 0.8);
      border: 1px solid rgba(63, 63, 70, 0.45);
      color: #71717a;
      font-size: 10px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .cam-key.active {
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.4);
    }

    /* Mobile adjustments */
    @media (max-width: 600px) {
      .admin-nav { top: 10px; left: 10px; gap: 6px; }
      .admin-nav-link { font-size: 11px; }
      .admin-nav-logo img { height: 16px; }
      .page-controls { top: 38px; left: 10px; }
      .cam-ctrl { bottom: calc(16px + env(safe-area-inset-bottom, 0px)); right: 16px; }
      .sim-viewport-wrap.portrait {
        width: min(390px, calc(100vw - 20px));
      }
    }

    /* CSS2DRenderer label styles (needed for zone/agent labels) */
    .agent-label {
      font-family: 'Inter', sans-serif;
      font-size: 10px;
      font-weight: 500;
      color: #fafafa;
      text-shadow: 0 1px 4px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.5);
      pointer-events: none;
      white-space: nowrap;
      user-select: none;
    }
    .zone-label {
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: #22c55e;
      opacity: 0.85;
      text-shadow: 0 0 10px rgba(34,197,94,0.4), 0 1px 3px rgba(0,0,0,0.8);
      pointer-events: none;
      white-space: nowrap;
      user-select: none;
    }
    .bubble-wrapper { pointer-events: none; user-select: none; }
    .activity-bubble {
      font-family: 'Inter', sans-serif;
      font-size: 9px;
      font-weight: 500;
      color: #e4e4e7;
      background: rgba(24, 24, 27, 0.92);
      border: 1px solid rgba(63, 63, 70, 0.5);
      border-radius: 10px;
      padding: 4px 8px;
      pointer-events: none;
      white-space: nowrap;
      user-select: none;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      transform-origin: center bottom;
      will-change: transform, opacity;
    }
    .activity-bubble.bubble-enter {
      animation: bubbleEnter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    .activity-bubble.bubble-bob {
      animation: bubbleBob 2.5s ease-in-out infinite;
      opacity: 0.85;
    }
    .activity-bubble.bubble-exit {
      animation: bubbleExit 1.2s ease-in-out forwards;
    }
    @keyframes bubbleEnter {
      0% { transform: scale(0) translateY(8px); opacity: 0; }
      50% { transform: scale(1.12) translateY(-2px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    @keyframes bubbleBob {
      0%, 100% { transform: translateY(0); opacity: 0.85; }
      50% { transform: translateY(-3px); opacity: 0.95; }
    }
    @keyframes bubbleExit {
      0% { transform: scale(1) translateY(0); opacity: 0.85; }
      40% { transform: scale(0.95) translateY(-2px); opacity: 0.5; }
      100% { transform: scale(0.85) translateY(-6px); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="admin-nav">
    <a href="/" class="admin-nav-logo"><img src="/clawnads-logo-white.svg" alt="Clawnads"></a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/analytics" class="admin-nav-link">Analytics</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/sim" class="admin-nav-link">Sim</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/character" class="admin-nav-link">Character</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/invites" class="admin-nav-link">Invites</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/elements" class="admin-nav-link admin-nav-active">Elements</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/store" class="admin-nav-link">Store</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/admin/store-manage" class="admin-nav-link">Store Ops</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/competitions" class="admin-nav-link">Competitions</a>
  </div>
  <div class="anav-profile" id="admin-nav-profile"></div>
  <div class="page-controls">
    <div class="orient-switch" id="orient-switch">
      <button class="orient-btn active" data-orient="landscape" title="Landscape">
        <svg width="16" height="12" viewBox="0 0 16 12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="0.75" y="0.75" width="14.5" height="10.5" rx="1.5"/>
        </svg>
      </button>
      <button class="orient-btn" data-orient="portrait" title="Portrait">
        <svg width="10" height="14" viewBox="0 0 10 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="0.75" y="0.75" width="8.5" height="12.5" rx="1.5"/>
        </svg>
      </button>
    </div>
  </div>
  <div class="sim-viewport-wrap landscape" id="sim-viewport-wrap">
        <div class="sim-toolbar">
          <div class="sound-wrap" id="sound-wrap">
            <button class="sound-toggle" id="sound-toggle" title="Music">
              <svg id="sound-icon-off" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <line x1="23" y1="9" x2="17" y2="15"></line>
                <line x1="17" y1="9" x2="23" y2="15"></line>
              </svg>
              <svg id="sound-icon-on" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
              </svg>
            </button>
            <div class="sound-menu" id="sound-menu">
              <button class="sound-menu-item" data-mode="lofi">
                <span class="sm-icon">ðŸŽµ</span>
                <span class="sm-label">Lo-fi</span>
              </button>
              <button class="sound-menu-item" data-mode="party">
                <span class="sm-icon">ðŸŽ‰</span>
                <span class="sm-label">Party</span>
              </button>
            </div>
          </div>
          <button class="sim-tool-btn" id="sim-fs-btn" title="Toggle fullscreen (F)">
            <svg id="fs-expand" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 3 21 3 21 9"></polyline>
              <polyline points="9 21 3 21 3 15"></polyline>
              <line x1="21" y1="3" x2="14" y2="10"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
            <svg id="fs-collapse" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
              <polyline points="4 14 10 14 10 20"></polyline>
              <polyline points="20 10 14 10 14 4"></polyline>
              <line x1="14" y1="10" x2="21" y2="3"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
          </button>
        </div>
        <audio id="lofi-audio" loop preload="metadata" src="/trading-floor/lofi.mp3"></audio>
        <audio id="party-audio" loop preload="metadata" src="/trading-floor/party.mp3"></audio>
        <div id="canvas-container"></div>
        <!-- Camera controller -->
        <div class="cam-ctrl" id="cam-ctrl">
          <div class="cam-top-row">
            <div class="cam-zoom-keys">
              <div class="cam-key" data-key="q">&minus;</div>
              <div class="cam-key" data-key="r">&#8634;</div>
              <div class="cam-key" data-key="e">+</div>
            </div>
            <div class="cam-keys" id="cam-keys">
              <div class="cam-keys-row"><div class="cam-key" data-key="w">W</div></div>
              <div class="cam-keys-row">
                <div class="cam-key" data-key="a">A</div>
                <div class="cam-key" data-key="s">S</div>
                <div class="cam-key" data-key="d">D</div>
              </div>
            </div>
            <div class="cam-pad" id="cam-pad">
              <div class="cam-pad-knob" id="cam-knob"></div>
            </div>
          </div>
    </div>
  </div>

  <script>
    // Force V2, set compact mode
    window.__charVersion = 'v2';
    window.__simCompact = true;
    window.__simDisableDrag = true;
  </script>
  <script type="module" src="/trading-floor/main.js"></script>
  <script>
    const wrap = document.getElementById('sim-viewport-wrap');
    const fsBtn = document.getElementById('sim-fs-btn');
    const expandIcon = document.getElementById('fs-expand');
    const collapseIcon = document.getElementById('fs-collapse');
    const orientSwitch = document.getElementById('orient-switch');
    let isFullscreen = false;
    let orientation = 'landscape';

    // Orientation switcher
    orientSwitch.addEventListener('click', (e) => {
      const btn = e.target.closest('.orient-btn');
      if (!btn || btn.dataset.orient === orientation) return;
      orientation = btn.dataset.orient;
      orientSwitch.querySelectorAll('.orient-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      wrap.classList.remove('landscape', 'portrait');
      if (!isFullscreen) wrap.classList.add(orientation);
      if (window.__tradingFloor) setTimeout(() => window.__tradingFloor.resize(), 50);
    });

    // Fullscreen toggle
    function toggleFullscreen() {
      isFullscreen = !isFullscreen;
      wrap.classList.toggle('fullscreen', isFullscreen);
      document.body.classList.toggle('is-fullscreen', isFullscreen);
      if (!isFullscreen) {
        wrap.classList.add(orientation);
      } else {
        wrap.classList.remove('landscape', 'portrait');
      }
      expandIcon.style.display = isFullscreen ? 'none' : '';
      collapseIcon.style.display = isFullscreen ? '' : 'none';
      if (window.__tradingFloor) setTimeout(() => window.__tradingFloor.resize(), 50);
    }

    fsBtn.addEventListener('click', toggleFullscreen);
    document.addEventListener('keydown', (e) => {
      // Don't intercept keys when they're meant for camera controls
      if (['w','a','s','d','q','e','r'].includes(e.key.toLowerCase())) return;
      if (e.key === 'f' && !e.metaKey && !e.ctrlKey && !e.altKey &&
          document.activeElement?.tagName !== 'INPUT' && document.activeElement?.tagName !== 'TEXTAREA') {
        e.preventDefault();
        toggleFullscreen();
      }
      if (e.key === 'Escape' && isFullscreen) {
        e.preventDefault();
        toggleFullscreen();
      }
    });
  </script>
  <script>
    // Sound menu â€” lofi + party modes with dance
    (function() {
      const btn = document.getElementById('sound-toggle');
      const menu = document.getElementById('sound-menu');
      const soundWrap = document.getElementById('sound-wrap');
      const lofiAudio = document.getElementById('lofi-audio');
      const partyAudio = document.getElementById('party-audio');
      const iconOff = document.getElementById('sound-icon-off');
      const iconOn = document.getElementById('sound-icon-on');
      const menuItems = menu.querySelectorAll('.sound-menu-item');

      const tracks = { lofi: lofiAudio, party: partyAudio };
      let activeAudio = null;
      let currentMode = 'off';
      let menuOpen = false;
      let hoverTimer = null;

      partyAudio.addEventListener('error', () => { tracks.party = lofiAudio; });

      function setIconOn() { btn.classList.add('active'); iconOff.style.display = 'none'; iconOn.style.display = ''; }
      function setIconOff() { btn.classList.remove('active'); iconOff.style.display = ''; iconOn.style.display = 'none'; }
      function openMenu() { menuOpen = true; menu.classList.add('open'); }
      function closeMenu() { menuOpen = false; menu.classList.remove('open'); }
      function updateActiveItem() {
        menuItems.forEach(item => item.classList.toggle('active', item.dataset.mode === currentMode));
      }

      function setMode(mode) {
        currentMode = mode;
        closeMenu();
        updateActiveItem();
        if (mode === 'off') {
          if (activeAudio) { activeAudio.pause(); activeAudio = null; }
          setIconOff();
          if (window.__tradingFloor) window.__tradingFloor.setMusicMode('off');
        } else {
          const newTrack = tracks[mode] || lofiAudio;
          if (activeAudio && activeAudio !== newTrack) activeAudio.pause();
          activeAudio = newTrack;
          activeAudio.volume = mode === 'party' ? 0.45 : 0.35;
          if (activeAudio.paused) {
            activeAudio.play().catch(() => { currentMode = 'off'; setIconOff(); });
          }
          setIconOn();
          if (window.__tradingFloor) window.__tradingFloor.setMusicMode(mode);
        }
      }

      btn.addEventListener('click', (e) => { e.stopPropagation(); if (currentMode !== 'off') setMode('off'); });
      soundWrap.addEventListener('mouseenter', () => { clearTimeout(hoverTimer); openMenu(); });
      soundWrap.addEventListener('mouseleave', () => { hoverTimer = setTimeout(closeMenu, 200); });
      menuItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const mode = item.dataset.mode;
          if (mode === currentMode) setMode('off');
          else setMode(mode);
        });
      });
      document.addEventListener('click', (e) => { if (menuOpen && !soundWrap.contains(e.target)) closeMenu(); });
    })();
  </script>
  <script>
    // Camera controller â€” joystick + WASD
    (function() {
      const pad = document.getElementById('cam-pad');
      const knob = document.getElementById('cam-knob');

      let dragging = false;
      let padRect = null;
      let stickX = 0, stickY = 0;
      let loopId = null;

      function getFloor() { return window.__tradingFloor; }

      function loop() {
        loopId = requestAnimationFrame(loop);
        const floor = getFloor();
        if (!floor || !floor.controls) return;
        if (Math.abs(stickX) < 0.05 && Math.abs(stickY) < 0.05) return;
        const rotateSpeed = 0.015;
        floor.userHasInteracted = true;
        floor.controls._rotateLeft(-stickX * rotateSpeed);
        floor.controls._rotateUp(stickY * rotateSpeed);
        floor.controls.update();
      }

      function startLoop() { if (!loopId) loopId = requestAnimationFrame(loop); }
      function stopLoop() { if (loopId) { cancelAnimationFrame(loopId); loopId = null; } }

      function startDrag(x, y) {
        dragging = true;
        padRect = pad.getBoundingClientRect();
        pad.classList.add('active');
        updateStick(x, y);
        startLoop();
      }

      function updateStick(x, y) {
        if (!dragging || !padRect) return;
        const cx = padRect.left + padRect.width / 2;
        const cy = padRect.top + padRect.height / 2;
        const maxR = padRect.width / 2 - 10;
        let dx = x - cx, dy = y - cy;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > maxR) { dx = dx / dist * maxR; dy = dy / dist * maxR; }
        knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
        stickX = dx / maxR;
        stickY = dy / maxR;
      }

      function endDrag() {
        if (!dragging) return;
        dragging = false;
        stickX = 0; stickY = 0;
        pad.classList.remove('active');
        knob.style.transform = 'translate(-50%, -50%)';
        stopLoop();
      }

      pad.addEventListener('mousedown', (e) => { e.preventDefault(); startDrag(e.clientX, e.clientY); });
      window.addEventListener('mousemove', (e) => { if (dragging) updateStick(e.clientX, e.clientY); });
      window.addEventListener('mouseup', endDrag);
      pad.addEventListener('touchstart', (e) => { e.preventDefault(); startDrag(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
      window.addEventListener('touchmove', (e) => { if (dragging && e.touches.length === 1) updateStick(e.touches[0].clientX, e.touches[0].clientY); }, { passive: true });
      window.addEventListener('touchend', endDrag);
      window.addEventListener('touchcancel', endDrag);

      // WASD + zoom + reset
      const keysDown = {};
      let wasdLoopId = null;
      const keyEls = {};
      document.querySelectorAll('.cam-key[data-key]').forEach(el => { keyEls[el.dataset.key] = el; });
      const arrowToWasd = { arrowup: 'w', arrowdown: 's', arrowleft: 'a', arrowright: 'd' };

      function highlightKey(key, on) {
        const wasd = arrowToWasd[key] || key;
        const el = keyEls[wasd];
        if (el) el.classList.toggle('active', on);
      }

      function wasdLoop() {
        wasdLoopId = requestAnimationFrame(wasdLoop);
        const floor = getFloor();
        if (!floor || !floor.controls || !floor.camera) return;
        const speed = 0.12;
        let dx = 0, dz = 0;
        if (keysDown['a'] || keysDown['arrowleft'])  dx -= 1;
        if (keysDown['d'] || keysDown['arrowright']) dx += 1;
        if (keysDown['w'] || keysDown['arrowup'])    dz += 1;
        if (keysDown['s'] || keysDown['arrowdown'])  dz -= 1;
        if (dx === 0 && dz === 0) return;
        const cam = floor.camera;
        const fx = floor.controls.target.x - cam.position.x;
        const fz = floor.controls.target.z - cam.position.z;
        const fLen = Math.sqrt(fx * fx + fz * fz) || 1;
        const fwdX = fx / fLen, fwdZ = fz / fLen;
        const rightX = -fwdZ, rightZ = fwdX;
        const moveX = (rightX * dx + fwdX * dz) * speed;
        const moveZ = (rightZ * dx + fwdZ * dz) * speed;
        floor.controls.target.x += moveX;
        floor.controls.target.z += moveZ;
        cam.position.x += moveX;
        cam.position.z += moveZ;
        floor.controls.update();
        floor.userHasInteracted = true;
      }

      function startWasdLoop() { if (!wasdLoopId) wasdLoopId = requestAnimationFrame(wasdLoop); }
      function stopWasdLoop() { if (wasdLoopId) { cancelAnimationFrame(wasdLoopId); wasdLoopId = null; } }

      function doZoom(factor) {
        const floor = getFloor();
        if (!floor || !floor.camera) return;
        floor.camera.zoom = Math.max(0.4, Math.min(2.5, floor.camera.zoom * factor));
        floor.camera.updateProjectionMatrix();
        if (floor.controls) floor.controls.update();
      }

      function doReset() {
        const floor = getFloor();
        if (!floor) return;
        floor.camera.zoom = 1;
        floor.camera.updateProjectionMatrix();
        floor._applyCameraMode();
        floor.userHasInteracted = false;
      }

      window.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        if (['w','a','s','d','arrowup','arrowdown','arrowleft','arrowright'].includes(key)) {
          e.preventDefault();
          if (!keysDown[key]) { keysDown[key] = true; highlightKey(key, true); startWasdLoop(); }
        }
        if (key === 'q') { e.preventDefault(); highlightKey('q', true); doZoom(1 / 1.15); }
        if (key === 'e') { e.preventDefault(); highlightKey('e', true); doZoom(1.15); }
        if (key === 'r') { e.preventDefault(); highlightKey('r', true); doReset(); }
      });

      window.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        delete keysDown[key];
        highlightKey(key, false);
        const anyHeld = ['w','a','s','d','arrowup','arrowdown','arrowleft','arrowright'].some(k => keysDown[k]);
        if (!anyHeld) stopWasdLoop();
      });
    })();
  </script>
  <script src="/admin-nav.js"></script>
</body>
</html>
