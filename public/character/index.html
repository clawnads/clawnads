<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>Clawnads Character</title>
  <link rel="icon" type="image/svg+xml" href="/clawnads-favicon-white.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/admin-nav.css">
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
    }
  }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #09090b;
      overflow: hidden;
      font-family: 'Inter', -apple-system, sans-serif;
      color: #fafafa;
    }
    #canvas-container {
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      position: relative;
      touch-action: none;
    }

    /* Admin nav */
    .admin-nav {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-nav-logo img { height: 18px; width: auto; opacity: 0.4; transition: opacity 0.2s; display: block; }
    .admin-nav-logo:hover img { opacity: 0.7; }
    .admin-nav-sep { color: #27272a; font-size: 12px; user-select: none; }
    .admin-nav-link { color: #71717a; text-decoration: none; font-size: 12px; font-weight: 500; transition: color 0.15s; }
    .admin-nav-link:hover { color: #fafafa; }
    .admin-nav-active { color: #a1a1aa; }

    /* FPS â€” hidden, use browser devtools instead */
    .char-fps { display: none; }

    /* Model variant dropdown */
    .char-panel select {
      background: rgba(24, 24, 27, 0.85);
      border: 1px solid #27272a;
      border-radius: 6px;
      color: #a1a1aa;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 500;
      padding: 6px 12px;
      cursor: pointer;
      outline: none;
      width: 100%;
      transition: border-color 0.15s;
    }
    .char-panel select:hover { border-color: #3f3f46; color: #e4e4e7; }
    .char-panel select:focus { border-color: #22c55e; color: #22c55e; }

    /* Controls container */
    .char-controls {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 14px;
      width: 240px;
    }
    .char-panel {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .v2-controls-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(9, 9, 11, 0.88);
      border: 1px solid #1e1e22;
      border-radius: 12px;
      padding: 14px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .char-btn-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .char-panel-title {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: #52525b;
      margin-bottom: 2px;
    }
    .char-panel button {
      background: rgba(24, 24, 27, 0.85);
      border: 1px solid #27272a;
      border-radius: 6px;
      color: #a1a1aa;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 500;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
    }
    .char-panel button:hover {
      border-color: #3f3f46;
      color: #e4e4e7;
    }
    .char-panel button.active {
      border-color: #22c55e;
      color: #22c55e;
      background: rgba(34, 197, 94, 0.08);
    }

    /* Cape color swatches */
    .cape-swatches {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      align-items: center;
    }
    .cape-swatch {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid #27272a;
      cursor: pointer;
      transition: all 0.15s;
      padding: 0;
      font-size: 0;
      line-height: 22px;
    }
    .cape-swatch:hover {
      border-color: #52525b;
      transform: scale(1.15);
    }
    .cape-swatch.active {
      border-color: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.4);
      transform: scale(1.15);
    }
    .cape-none {
      background: #18181b !important;
      font-size: 9px;
      color: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cape-none.active {
      color: #22c55e;
    }

    /* Cape options row (logo toggle sits beside swatches) */
    .cape-options {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 2px;
    }

    /* Hint toast */
    .char-hint {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      font-size: 10px;
      color: #52525b;
      background: rgba(24, 24, 27, 0.85);
      border: 1px solid #27272a;
      border-radius: 6px;
      padding: 6px 10px;
      pointer-events: none;
      animation: hintFade 6s ease-in-out forwards;
    }
    @keyframes hintFade {
      0%, 60% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Admin tools container (Sprite Lab + Skin Assignment) */
    .admin-tools {
      position: fixed;
      top: 50px;
      right: 20px;
      z-index: 100;
      width: 320px;
      display: none; /* shown after admin session check */
      flex-direction: column;
      gap: 10px;
    }
    .admin-tools.visible { display: flex; }

    /* Tab row */
    .admin-tab-row {
      display: flex;
      gap: 4px;
      align-self: flex-end;
    }
    .admin-tab-btn {
      background: rgba(24, 24, 27, 0.85);
      border: 1px solid #27272a;
      border-radius: 6px;
      color: #71717a;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 500;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.15s;
      backdrop-filter: blur(8px);
    }
    .admin-tab-btn:hover { border-color: #3f3f46; color: #e4e4e7; }
    .admin-tab-btn.active { border-color: #a78bfa; color: #a78bfa; background: rgba(167, 139, 250, 0.08); }
    .admin-tab-btn.dimmed { opacity: 0.5; }

    /* Sprite Lab panel */
    .sprite-lab {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    /* Skin Assignment panel */
    .skin-panel {
      display: none;
      flex-direction: column;
      gap: 8px;
      background: rgba(24, 24, 27, 0.92);
      border: 1px solid #27272a;
      border-radius: 10px;
      padding: 14px;
      backdrop-filter: blur(12px);
    }
    .skin-panel.open { display: flex; }
    .skin-panel-title {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: #a78bfa;
    }
    .skin-agent-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .skin-agent-row:last-of-type { border-bottom: none; }
    .skin-agent-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      background: #18181b; overflow: hidden; flex-shrink: 0;
    }
    .skin-agent-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .skin-agent-name {
      flex: 1; font-size: 12px; font-weight: 500; color: #e4e4e7;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .skin-swatches { display: flex; gap: 4px; flex-shrink: 0; }
    .skin-swatch {
      width: 24px; height: 24px; border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer; transition: all 0.15s;
    }
    .skin-swatch:hover { border-color: rgba(255,255,255,0.2); }
    .skin-swatch.active { border-color: #fafafa; }
    .skin-swatch.pending { border-color: #a78bfa; border-style: dashed; }
    .skin-swatch[data-skin="red"] { background: #b91c1c; }
    .skin-swatch[data-skin="blue"] { background: #1d4ed8; }
    .skin-swatch[data-skin="gold"] { background: #a16207; }
    .skin-save-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
    }
    .skin-save-btn {
      background: rgba(167, 139, 250, 0.12);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: 6px;
      color: #a78bfa;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 600;
      padding: 6px 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .skin-save-btn:hover { background: rgba(167, 139, 250, 0.2); color: #c4b5fd; }
    .skin-save-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .skin-save-status {
      font-size: 10px;
      color: #52525b;
      flex: 1;
    }
    .sprite-lab-body {
      display: none;
      flex-direction: column;
      gap: 8px;
      background: rgba(24, 24, 27, 0.92);
      border: 1px solid #27272a;
      border-radius: 10px;
      padding: 14px;
      backdrop-filter: blur(12px);
    }
    .sprite-lab-body.open { display: flex; }
    .sprite-lab-title {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: #a78bfa;
    }
    .sprite-lab textarea {
      background: rgba(9, 9, 11, 0.6);
      border: 1px solid #27272a;
      border-radius: 6px;
      color: #e4e4e7;
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      padding: 8px 10px;
      resize: vertical;
      min-height: 60px;
      max-height: 150px;
      outline: none;
      transition: border-color 0.15s;
    }
    .sprite-lab textarea:focus { border-color: #a78bfa; }
    .sprite-lab textarea::placeholder { color: #3f3f46; }
    .sprite-lab-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .sprite-lab-btn {
      background: rgba(167, 139, 250, 0.12);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: 6px;
      color: #a78bfa;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 600;
      padding: 6px 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .sprite-lab-btn:hover { background: rgba(167, 139, 250, 0.2); color: #c4b5fd; }
    .sprite-lab-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .sprite-lab-status {
      font-size: 10px;
      color: #52525b;
      flex: 1;
    }
    .sprite-lab-options {
      display: flex;
      gap: 12px;
    }
    .sprite-lab-option {
      font-size: 11px;
      color: #71717a;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .sprite-lab-option input[type="radio"] { accent-color: #a78bfa; }
    .sprite-lab-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    .sprite-lab-cell {
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #27272a;
      background: #18181b;
    }
    .sprite-lab-cell img {
      width: 100%;
      aspect-ratio: 1;
      display: block;
      object-fit: cover;
    }
    .sprite-lab-cell-label {
      position: absolute;
      top: 4px;
      left: 4px;
      font-size: 9px;
      font-weight: 600;
      color: #a1a1aa;
      background: rgba(9, 9, 11, 0.75);
      padding: 2px 5px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .sprite-lab-cell-dl {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(24, 24, 27, 0.9);
      border: 1px solid #3f3f46;
      border-radius: 4px;
      color: #a1a1aa;
      font-size: 9px;
      font-weight: 500;
      padding: 3px 6px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.15s;
      display: none;
    }
    .sprite-lab-cell-dl:hover { color: #fafafa; border-color: #52525b; }
    .sprite-lab-cell.has-result .sprite-lab-cell-dl { display: block; }
    .sprite-lab-cell.generating {
      animation: spritePulse 1.5s ease-in-out infinite;
    }
    @keyframes spritePulse {
      0%, 100% { border-color: #27272a; }
      50% { border-color: #a78bfa; }
    }
    .sprite-lab-cell.failed { border-color: #ef4444; }
    .sprite-lab-dl-sheet {
      width: 100%;
      text-align: center;
      margin-top: 2px;
    }

    /* Mobile */
    @media (max-width: 600px) {
      .admin-nav { top: 10px; left: 10px; gap: 6px; }
      .admin-nav-link { font-size: 11px; }
      .admin-nav-logo img { height: 16px; }
      .char-controls { bottom: 12px; left: 12px; gap: 10px; }
      .char-panel button { font-size: 10px; padding: 5px 10px; }
      .cape-swatch { width: 20px; height: 20px; }
      .char-hint { bottom: 12px; right: 12px; font-size: 9px; }
      .admin-tools { width: 260px; right: 12px; top: 40px; }
    }
  </style>
</head>
<body>
  <div class="admin-nav">
    <a href="/" class="admin-nav-logo"><img src="/clawnads-logo-white.svg" alt="Clawnads"></a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/analytics" class="admin-nav-link">Analytics</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/sim" class="admin-nav-link">Sim</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/character" class="admin-nav-link admin-nav-active">Character</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/invites" class="admin-nav-link">Invites</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/elements" class="admin-nav-link">Elements</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/store" class="admin-nav-link">Store</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/admin/store-manage" class="admin-nav-link">Store Ops</a>
    <span class="admin-nav-sep">&middot;</span>
    <a href="/competitions" class="admin-nav-link">Competitions</a>
  </div>
  <div class="anav-profile" id="admin-nav-profile"></div>
  <div class="char-fps" id="char-fps"></div>
  <div class="char-controls">
    <div class="char-panel" id="char-version">
      <div class="char-panel-title">Version</div>
      <div class="char-btn-row">
        <button id="toggle-v2">V2 â€” Meshy</button>
        <button id="toggle-v1">V1 â€” Primitives</button>
      </div>
    </div>
    <div id="v1-controls">
      <div class="char-panel" id="char-toggle">
        <div class="char-panel-title">Character</div>
        <div class="char-btn-row">
          <button id="toggle-lobster" class="active">ðŸ¦ž Lobster</button>
          <button id="toggle-human">ðŸ§‘ Human</button>
        </div>
      </div>
      <div class="char-panel" id="char-anim">
        <div class="char-panel-title">Animation</div>
        <div class="char-btn-row">
          <button id="anim-idle" class="active">Idle</button>
          <button id="anim-walk">Walk</button>
          <button id="anim-run">Run</button>
        </div>
      </div>
      <div class="char-panel" id="char-panel">
        <div class="char-panel-title">Accessories</div>
      </div>
      <div class="char-panel" id="char-cape">
        <div class="char-panel-title">Cape</div>
        <div class="cape-swatches"></div>
        <div class="cape-options">
          <button id="cape-logo-toggle">âœ¦ Logo</button>
        </div>
      </div>
    </div>
    <div id="v2-controls" class="v2-controls-panel" style="display:none">
      <div class="char-panel" id="char-model-v2">
        <div class="char-panel-title">Model</div>
        <select id="model-variant-select">
          <option value="red">Red</option>
          <option value="blue">Blue</option>
          <option value="gold">Gold</option>
          <option value="purple">Purple</option>
          <option value="shadow">Shadow</option>
        </select>
      </div>
      <div class="char-panel" id="char-anim-v2">
        <div class="char-panel-title">Animation</div>
        <select id="anim-base-select">
          <option value="idle">Idle</option>
          <option value="walk">Walk</option>
          <option value="run">Run</option>
        </select>
      </div>
      <div class="char-panel" id="char-extras-v2">
        <div class="char-panel-title">Dance</div>
        <select id="extras-dance-select" disabled>
          <option value="">None available</option>
        </select>
      </div>
      <div class="char-panel" id="char-exercise-v2">
        <div class="char-panel-title">Exercise</div>
        <select id="extras-exercise-select" disabled>
          <option value="">None available</option>
        </select>
      </div>
      <div class="char-panel" id="char-fight-v2">
        <div class="char-panel-title">Fight</div>
        <select id="extras-fight-select" disabled>
          <option value="">None available</option>
        </select>
      </div>
      <div class="char-panel" id="char-texture">
        <div class="char-panel-title">Texture</div>
        <select id="texture-select">
          <option value="meshy">Meshy</option>
          <option value="clay">Base Clay</option>
          <option value="shadow">Shadow</option>
        </select>
      </div>
    </div>
  </div>
  <div class="admin-tools" id="admin-tools">
    <div class="admin-tab-row">
      <button class="admin-tab-btn active" id="tab-sprite" data-tab="sprite">ðŸŽ¨ Sprite Lab</button>
      <button class="admin-tab-btn" id="tab-skins" data-tab="skins">ðŸ¦ž Agent Skins</button>
    </div>
    <div class="sprite-lab" id="sprite-lab">
    <div class="sprite-lab-body open" id="sprite-lab-body">
      <div class="sprite-lab-title">Sprite Lab</div>
      <textarea id="sprite-prompt" placeholder="Style prompt, e.g. &quot;cute pixel art&quot;, &quot;watercolor painted&quot;, &quot;cyberpunk neon&quot;, &quot;claymation&quot;"></textarea>
      <div class="sprite-lab-options">
        <label class="sprite-lab-option">
          <input type="radio" name="sprite-angles" value="4" checked> 4 angles
        </label>
        <label class="sprite-lab-option">
          <input type="radio" name="sprite-angles" value="6"> 6 angles
        </label>
      </div>
      <div class="sprite-lab-actions">
        <button class="sprite-lab-btn" id="sprite-generate">Generate</button>
        <span class="sprite-lab-status" id="sprite-status"></span>
      </div>
      <div class="sprite-lab-grid" id="sprite-grid" style="display:none"></div>
      <button class="sprite-lab-btn sprite-lab-dl-sheet" id="sprite-dl-sheet" style="display:none">â¬‡ Download Sheet</button>
    </div>
    </div>
    <div class="skin-panel" id="skin-panel">
      <div class="skin-panel-title">Agent Skins</div>
      <div id="skin-agents-list">
        <div style="color:#52525b;font-size:12px;padding:12px 0;text-align:center;">Loading agentsâ€¦</div>
      </div>
      <div class="skin-save-row">
        <button class="skin-save-btn" id="skin-save-btn" disabled>Save</button>
        <span class="skin-save-status" id="skin-save-status"></span>
      </div>
    </div>
  </div>
  <div class="char-hint" id="char-hint">Double-click ground to move</div>
  <div id="canvas-container">
    <div id="loading-overlay" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:10;flex-direction:column;gap:12px;pointer-events:none;">
      <div style="width:32px;height:32px;border:3px solid #333;border-top-color:#22c55e;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
      <div style="color:#888;font-family:system-ui;font-size:13px;">Loading modelâ€¦</div>
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    </div>
  </div>
  <script type="module" src="/character/viewer.js"></script>
  <script>
    // Admin session gate + tab switching + Sprite Lab + Skin Assignment
    (function() {
      const adminTools = document.getElementById('admin-tools');
      const tabBtns = document.querySelectorAll('.admin-tab-btn');
      const spriteLab = document.getElementById('sprite-lab');
      const skinPanel = document.getElementById('skin-panel');
      // --- Admin session check ---
      fetch('/admin/api/session').then(r => r.json()).then(data => {
        if (data.authenticated) adminTools.classList.add('visible');
      }).catch(() => {});

      // --- Tab switching (click active tab to collapse, Escape to dismiss) ---
      let activeTab = 'sprite'; // tracks which tab is open, or null if collapsed

      function showTab(tab) {
        activeTab = tab;
        tabBtns.forEach(b => {
          b.classList.toggle('active', b.dataset.tab === tab);
          b.classList.remove('dimmed');
        });
        spriteLab.style.display = tab === 'sprite' ? '' : 'none';
        skinPanel.classList.toggle('open', tab === 'skins');
        if (tab === 'sprite') setTimeout(refreshCaptures, 50);
        if (tab === 'skins' && !skinLoaded) loadSkinAgents();
      }

      function collapseAll() {
        activeTab = null;
        tabBtns.forEach(b => { b.classList.remove('active'); b.classList.add('dimmed'); });
        spriteLab.style.display = 'none';
        skinPanel.classList.remove('open');
      }

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          if (tab === activeTab) {
            collapseAll(); // toggle off
          } else {
            showTab(tab);
          }
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && activeTab) {
          collapseAll();
        }
      });

      // ============================================================
      // Sprite Lab
      // ============================================================
      const body = document.getElementById('sprite-lab-body');
      const promptEl = document.getElementById('sprite-prompt');
      const genBtn = document.getElementById('sprite-generate');
      const statusEl = document.getElementById('sprite-status');
      const grid = document.getElementById('sprite-grid');
      const dlSheetBtn = document.getElementById('sprite-dl-sheet');
      const radios = document.querySelectorAll('input[name="sprite-angles"]');

      let currentCaptures = [];
      let isGenerating = false;

      function buildCell(name, imgSrc, opts = {}) {
        const cell = document.createElement('div');
        cell.className = 'sprite-lab-cell' + (opts.hasResult ? ' has-result' : '') + (opts.generating ? ' generating' : '');
        const img = document.createElement('img');
        img.src = imgSrc;
        img.alt = name;
        cell.appendChild(img);
        const label = document.createElement('div');
        label.className = 'sprite-lab-cell-label';
        label.textContent = name;
        cell.appendChild(label);
        if (opts.hasResult) {
          const dl = document.createElement('a');
          dl.className = 'sprite-lab-cell-dl';
          dl.href = imgSrc;
          dl.download = `sprite-${name.toLowerCase().replace(/[^a-z0-9]/g, '-')}-${Date.now()}.png`;
          dl.textContent = 'â¬‡';
          cell.appendChild(dl);
        }
        return cell;
      }

      async function runWithConcurrency(tasks, limit) {
        const results = new Array(tasks.length);
        let next = 0;
        async function worker() {
          while (next < tasks.length) {
            const i = next++;
            try { results[i] = { ok: true, value: await tasks[i]() }; }
            catch (e) { results[i] = { ok: false, error: e }; }
          }
        }
        const workers = [];
        for (let w = 0; w < Math.min(limit, tasks.length); w++) workers.push(worker());
        await Promise.all(workers);
        return results;
      }

      function setStatus(text, color) {
        statusEl.textContent = text;
        statusEl.style.color = color || '#52525b';
      }

      function getAngleCount() {
        return parseInt(document.querySelector('input[name="sprite-angles"]:checked').value) || 4;
      }

      let generatedResults = [];

      function stitchAndDownload() {
        if (!generatedResults.length) return;
        const cols = 2;
        const rows = Math.ceil(generatedResults.length / cols);
        const cellSize = 1024;
        const canvas = document.createElement('canvas');
        canvas.width = cols * cellSize;
        canvas.height = rows * cellSize;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#09090b';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        let loaded = 0;
        const images = [];
        generatedResults.forEach((res, i) => {
          const img = new Image();
          img.onload = () => {
            loaded++;
            images[i] = img;
            if (loaded === generatedResults.length) {
              images.forEach((im, j) => {
                const col = j % cols;
                const row = Math.floor(j / cols);
                ctx.drawImage(im, col * cellSize, row * cellSize, cellSize, cellSize);
              });
              const link = document.createElement('a');
              link.download = `sprite-sheet-${generatedResults.length}up-${Date.now()}.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
            }
          };
          img.src = res;
        });
      }

      function refreshCaptures() {
        if (isGenerating) return;
        const viewer = window.characterViewer;
        if (!viewer || !viewer.character) return;
        currentCaptures = viewer.captureAllAngles(getAngleCount(), 1024);
        showCaptures();
      }

      function showCaptures() {
        grid.innerHTML = '';
        for (const cap of currentCaptures) {
          grid.appendChild(buildCell(cap.name, cap.dataUrl));
        }
        grid.style.display = currentCaptures.length ? 'grid' : 'none';
        setStatus('', '');
      }

      radios.forEach(r => r.addEventListener('change', refreshCaptures));

      genBtn.addEventListener('click', async () => {
        const text = promptEl.value.trim();
        if (!text) { setStatus('Enter a style prompt first', '#ef4444'); return; }
        if (!currentCaptures.length) { setStatus('No captures yet', '#ef4444'); return; }

        isGenerating = true;
        genBtn.disabled = true;
        dlSheetBtn.style.display = 'none';
        generatedResults = new Array(currentCaptures.length).fill(null);

        for (const cell of grid.children) cell.classList.add('generating');

        let completed = 0;
        setStatus(`Generating 0/${currentCaptures.length}â€¦`, '#a78bfa');

        function buildPrompt(angleName) {
          const lower = angleName.toLowerCase();
          const isFront = lower === 'front' || lower.includes('front');
          const eyeNote = isFront
            ? 'The eyes must remain as simple solid black dots â€” do not texture, pattern, or stylize the eyes.'
            : 'This is a ' + angleName.toLowerCase() + ' view â€” there are NO eyes visible from this angle. Do not add or hallucinate any eyes.';
          return `Retexture this 3D character model (${angleName.toLowerCase()} view) in the following style: ${text}. Maintain the exact same pose, silhouette, and proportions. ${eyeNote} Output a square image.`;
        }

        async function generateOne(cap) {
          const doFetch = () => fetch('/admin/texture/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: buildPrompt(cap.name), referenceImage: cap.dataUrl })
          }).then(r => {
            if (r.status === 401 || r.status === 403) throw new Error('Session expired');
            return r.json().then(data => {
              if (!r.ok) throw new Error(data.error || 'Generation failed');
              return data;
            });
          });
          try { return await doFetch(); }
          catch (e) {
            await new Promise(ok => setTimeout(ok, 2000));
            return doFetch();
          }
        }

        const tasks = currentCaptures.map((cap, i) => () =>
          generateOne(cap)
          .then(data => {
            completed++;
            setStatus(`Generating ${completed}/${currentCaptures.length}â€¦`, '#a78bfa');
            const resultUrl = `data:${data.mimeType};base64,${data.image}`;
            generatedResults[i] = resultUrl;
            const newCell = buildCell(cap.name, resultUrl, { hasResult: true });
            grid.children[i].replaceWith(newCell);
          })
          .catch(err => {
            completed++;
            setStatus(`Generating ${completed}/${currentCaptures.length}â€¦`, '#a78bfa');
            const failCell = grid.children[i];
            if (failCell) {
              failCell.classList.remove('generating');
              failCell.classList.add('failed');
              const label = failCell.querySelector('.sprite-lab-cell-label');
              if (label) label.textContent = cap.name + ' âœ—';
            }
          })
        );

        await runWithConcurrency(tasks, 1);
        setStatus('Done âœ“', '#22c55e');
        genBtn.disabled = false;
        isGenerating = false;
        if (generatedResults.some(r => r !== null)) dlSheetBtn.style.display = 'block';
      });

      dlSheetBtn.addEventListener('click', () => {
        const valid = generatedResults.filter(r => r !== null);
        if (valid.length) stitchAndDownload();
      });

      promptEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          genBtn.click();
        }
      });

      // Refresh captures on first load (Sprite Lab is default tab, body starts open)
      // Wait for character to load
      const captureWait = setInterval(() => {
        if (window.characterViewer && window.characterViewer.character) {
          clearInterval(captureWait);
          setTimeout(refreshCaptures, 200);
        }
      }, 500);

      // ============================================================
      // Skin Assignment Panel
      // ============================================================
      const skinList = document.getElementById('skin-agents-list');
      const skinSaveBtn = document.getElementById('skin-save-btn');
      const skinSaveStatus = document.getElementById('skin-save-status');

      const SKINS = [
        { key: 'red',  title: 'Red' },
        { key: 'blue', title: 'Blue' },
        { key: 'gold', title: 'Gold' },
      ];

      let skinAgents = [];
      let skinLoaded = false;
      // Track pending changes: { agentName: newSkin }
      let pendingChanges = {};

      async function loadSkinAgents() {
        try {
          const res = await fetch('/agents/');
          const data = await res.json();
          skinAgents = (data.agents || []).filter(a => a.x402Verified);
          renderSkins();
          skinLoaded = true;
        } catch (e) {
          skinList.innerHTML = '<div style="color:#ef4444;font-size:12px;padding:12px 0;text-align:center;">Failed to load agents</div>';
        }
      }

      function renderSkins() {
        if (!skinAgents.length) {
          skinList.innerHTML = '<div style="color:#52525b;font-size:12px;padding:12px 0;text-align:center;">No verified agents</div>';
          return;
        }
        skinList.innerHTML = '';
        for (const agent of skinAgents) {
          const row = document.createElement('div');
          row.className = 'skin-agent-row';

          const avatar = document.createElement('div');
          avatar.className = 'skin-agent-avatar';
          if (agent.avatarUrl) {
            const img = document.createElement('img');
            img.src = agent.avatarUrl;
            img.alt = agent.name;
            avatar.appendChild(img);
          }

          const name = document.createElement('div');
          name.className = 'skin-agent-name';
          name.textContent = agent.name;

          const swatches = document.createElement('div');
          swatches.className = 'skin-swatches';
          const savedSkin = agent.characterSkin || 'red';
          const currentSkin = pendingChanges[agent.name] || savedSkin;

          for (const skin of SKINS) {
            const sw = document.createElement('button');
            sw.className = 'skin-swatch';
            if (currentSkin === skin.key) sw.classList.add('active');
            if (pendingChanges[agent.name] && pendingChanges[agent.name] === skin.key && pendingChanges[agent.name] !== savedSkin) {
              sw.classList.add('pending');
            }
            sw.dataset.skin = skin.key;
            sw.title = skin.title;
            sw.addEventListener('click', () => selectSkin(agent.name, skin.key, savedSkin));
            swatches.appendChild(sw);
          }

          row.appendChild(avatar);
          row.appendChild(name);
          row.appendChild(swatches);
          skinList.appendChild(row);
        }
      }

      function selectSkin(agentName, skin, savedSkin) {
        if (skin === savedSkin) {
          delete pendingChanges[agentName];
        } else {
          pendingChanges[agentName] = skin;
        }
        renderSkins();
        updateSaveBtn();
      }

      function updateSaveBtn() {
        const hasChanges = Object.keys(pendingChanges).length > 0;
        skinSaveBtn.disabled = !hasChanges;
        skinSaveStatus.textContent = hasChanges
          ? `${Object.keys(pendingChanges).length} change${Object.keys(pendingChanges).length > 1 ? 's' : ''}`
          : '';
        skinSaveStatus.style.color = hasChanges ? '#a78bfa' : '#52525b';
      }

      skinSaveBtn.addEventListener('click', saveSkins);

      async function saveSkins() {
        const changes = Object.entries(pendingChanges);
        if (!changes.length) return;

        skinSaveBtn.disabled = true;
        skinSaveStatus.textContent = 'Savingâ€¦';
        skinSaveStatus.style.color = '#a78bfa';

        let saved = 0;
        let failed = 0;

        for (const [agentName, skin] of changes) {
          try {
            const res = await fetch(`/admin/agents/${encodeURIComponent(agentName)}/skin`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ skin }),
            });
            if (!res.ok) throw new Error('Failed');
            // Update local agent data
            const agent = skinAgents.find(a => a.name === agentName);
            if (agent) agent.characterSkin = skin;
            delete pendingChanges[agentName];
            saved++;
          } catch (e) {
            failed++;
            console.error('[skin] save failed for', agentName, e.message);
          }
        }

        renderSkins();
        updateSaveBtn();

        if (failed) {
          skinSaveStatus.textContent = `${saved} saved, ${failed} failed`;
          skinSaveStatus.style.color = '#ef4444';
        } else {
          skinSaveStatus.textContent = 'Saved âœ“';
          skinSaveStatus.style.color = '#22c55e';
          setTimeout(() => {
            if (skinSaveStatus.textContent === 'Saved âœ“') {
              skinSaveStatus.textContent = '';
            }
          }, 3000);
        }
      }

      // Enter key triggers save when skin panel is active
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && skinPanel.classList.contains('open') && !skinSaveBtn.disabled) {
          e.preventDefault();
          skinSaveBtn.click();
        }
      });

    })();
  </script>
  <script src="/admin-nav.js"></script>
</body>
</html>
