<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Operator â€” Clawnads</title>
  <link rel="icon" type="image/svg+xml" href="/clawnads-favicon-white.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    html, body { margin: 0; min-height: 100vh; background: var(--color-bg-deep); }
    body { color: var(--color-text-primary); font-family: var(--font-sans); display: flex; flex-direction: column; }

    /* ---- Layout: table left, detail right ---- */
    .op-layout {
      flex: 1; display: flex; min-height: 0;
    }
    .op-list-panel {
      flex: 1; min-width: 0; overflow-y: auto;
    }
    .op-detail-panel {
      width: 380px; flex-shrink: 0;
      border-left: 1px solid var(--color-border);
      display: flex; flex-direction: column;
      overflow-y: auto;
    }

    /* ---- Agent table (matches dashboard) ---- */
    .op-table {
      width: 100%; border-collapse: separate; border-spacing: 0;
    }
    .op-table th {
      text-align: left;
      padding: var(--space-6) var(--space-8);
      font-size: var(--text-xs); font-weight: 500;
      color: var(--color-text-muted);
      text-transform: uppercase; letter-spacing: 0.05em;
      border-bottom: 1px solid var(--color-border);
      white-space: nowrap;
    }
    .op-table th:first-child { padding-left: var(--space-16); }
    .op-table th:last-child { padding-right: var(--space-16); text-align: right; }
    .op-table td {
      padding: var(--space-6) var(--space-8);
      border: none; font-size: var(--text-md); vertical-align: middle;
    }
    .op-table td:first-child { padding-left: var(--space-16); }
    .op-table td:last-child { padding-right: var(--space-16); text-align: right; }
    .op-table tbody tr {
      cursor: pointer; transition: background var(--transition-fast); height: 60px;
    }
    .op-table tbody tr:hover { background: rgba(255,255,255,0.03); }
    .op-table tbody tr.selected { background: rgba(34,197,94,0.08); }

    .op-name-cell { display: flex; align-items: center; gap: var(--space-4); }
    .op-tbl-avatar {
      width: 32px; height: 32px; border-radius: 50%;
      background: linear-gradient(135deg, var(--color-accent), #a855f7);
      display: flex; align-items: center; justify-content: center;
      font-size: var(--text-xs); font-weight: 700; color: white; overflow: hidden; flex-shrink: 0;
    }
    .op-tbl-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .op-tbl-name { font-weight: 600; font-size: var(--text-md); }
    .op-tbl-desc {
      font-size: var(--text-xs); color: var(--color-text-tertiary);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;
    }
    .op-tbl-wallet { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--color-text-tertiary); white-space: nowrap; }
    .op-tbl-apps { font-size: var(--text-sm); color: var(--color-text-secondary); white-space: nowrap; }
    .op-tbl-status {
      display: inline-flex; align-items: center; gap: var(--space-2);
      font-size: var(--text-xs); color: var(--color-text-muted); white-space: nowrap;
    }
    .op-dot { width: 6px; height: 6px; border-radius: 50%; }
    .op-dot.online { background: var(--color-success); }
    .op-dot.offline { background: var(--color-text-muted); }

    /* ---- Detail panel ---- */
    .op-detail-header {
      display: flex; align-items: center; gap: var(--space-4);
      padding: var(--space-8) var(--space-10);
      border-bottom: 1px solid var(--color-border);
    }
    .op-detail-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, var(--color-accent), #a855f7);
      display: flex; align-items: center; justify-content: center;
      font-size: var(--text-sm); font-weight: 700; color: white; overflow: hidden; flex-shrink: 0;
    }
    .op-detail-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .op-detail-name { font-size: var(--text-lg); font-weight: 700; }
    .op-detail-wallet { font-size: var(--text-xs); color: var(--color-text-tertiary); font-family: var(--font-mono); }

    .op-detail-section-title {
      font-size: var(--text-xs); font-weight: 600; color: var(--color-text-muted);
      text-transform: uppercase; letter-spacing: 0.05em;
      padding: var(--space-6) var(--space-10) var(--space-3);
    }

    .op-detail-body { flex: 1; overflow-y: auto; }

    /* App cards in detail */
    .op-app-card {
      padding: var(--space-4) var(--space-10);
      transition: background var(--transition-fast);
      cursor: pointer;
    }
    .op-app-card:hover { background: rgba(255,255,255,0.02); }
    .op-app-card.expanded { background: rgba(255,255,255,0.02); }
    .op-app-card-row {
      display: flex; align-items: center; gap: var(--space-4);
    }
    .op-app-icon {
      width: 28px; height: 28px; border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--color-accent), #a855f7);
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; color: white; overflow: hidden; flex-shrink: 0;
    }
    .op-app-icon img { width: 100%; height: 100%; object-fit: cover; }
    .op-app-info { flex: 1; min-width: 0; }
    .op-app-name { font-size: var(--text-sm); font-weight: 600; }
    .op-app-scopes-preview { font-size: var(--text-xs); color: var(--color-text-tertiary); margin-top: 1px; }
    .op-app-meta { font-size: 10px; color: var(--color-text-muted); margin-top: 1px; }
    .op-app-chevron {
      width: 14px; height: 14px; color: var(--color-text-muted); flex-shrink: 0;
      transition: transform 0.15s ease;
    }
    .op-app-card.expanded .op-app-chevron { transform: rotate(180deg); }

    /* Status dot next to app name */
    .op-app-status-dot {
      width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
      background: var(--color-success); display: inline-block;
      margin-left: var(--space-2); vertical-align: middle;
    }

    /* Revoked / dimmed state */
    .op-app-card.revoked { opacity: 0.45; }
    .op-app-card.revoked:hover { opacity: 0.6; }
    .op-app-card.revoked.expanded { opacity: 0.7; }

    /* Expanded detail */
    .op-app-detail {
      display: none; padding: var(--space-4) 0 var(--space-2) 44px;
    }
    .op-app-card.expanded .op-app-detail { display: block; }
    .op-app-detail-desc {
      font-size: var(--text-xs); color: var(--color-text-secondary);
      line-height: var(--leading-relaxed); margin-bottom: var(--space-4);
    }
    .op-app-detail-section {
      margin-bottom: var(--space-4);
    }
    .op-app-detail-label {
      font-size: 10px; font-weight: 600; color: var(--color-text-muted);
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-2);
    }
    .op-app-detail-date {
      font-size: var(--text-xs); color: var(--color-text-tertiary);
    }
    .op-scope-list { display: flex; flex-direction: column; gap: var(--space-2); }
    .op-scope-row {
      display: flex; align-items: center; gap: var(--space-3);
      font-size: var(--text-xs);
    }
    .op-scope-dot {
      width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
    }
    .op-scope-dot.rw { background: var(--color-success); }
    .op-scope-dot.ro { background: var(--color-accent); }
    .op-scope-name { font-weight: 600; color: var(--color-text-secondary); min-width: 60px; }
    .op-scope-desc { color: var(--color-text-tertiary); }
    .op-scope-access-badge {
      font-size: 9px; font-weight: 600; padding: 1px 5px;
      border-radius: var(--radius-pill); white-space: nowrap;
    }
    .op-scope-access-badge.rw {
      background: rgba(34, 197, 94, 0.1); color: var(--color-success); border: 1px solid rgba(34, 197, 94, 0.2);
    }
    .op-scope-access-badge.ro {
      background: rgba(124, 92, 255, 0.1); color: var(--color-accent); border: 1px solid rgba(124, 92, 255, 0.2);
    }

    .op-btn-revoke {
      padding: var(--space-3) var(--space-6);
      background: none; border: 1px solid var(--color-border);
      border-radius: var(--radius-pill); color: var(--color-text-secondary);
      font-size: var(--text-xs); font-weight: 500; font-family: var(--font-sans);
      cursor: pointer; white-space: nowrap; transition: all var(--transition-fast);
      margin-top: var(--space-2);
    }
    .op-btn-revoke:hover { border-color: var(--color-error); color: var(--color-error); }
    .op-revoked-badge {
      display: inline-flex; align-items: center; gap: var(--space-2);
      font-size: var(--text-xs); color: var(--color-text-muted); white-space: nowrap;
      margin-top: var(--space-2);
    }

    /* Empty / sad crab */
    .op-empty {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: var(--space-16) var(--space-10); text-align: center; flex: 1;
    }
    .op-empty-crab { margin-bottom: var(--space-4); opacity: 0.25; }
    .op-empty-text { font-size: var(--text-sm); color: var(--color-text-tertiary); line-height: var(--leading-relaxed); }

    /* Select-agent prompt (no agent selected yet) */
    .op-select-prompt {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      flex: 1; padding: var(--space-16) var(--space-10); text-align: center;
    }
    .op-select-prompt-crab { margin-bottom: var(--space-4); opacity: 0.15; }
    .op-select-prompt-text { font-size: var(--text-sm); color: var(--color-text-muted); }

    /* ---- Login card ---- */
    .op-login-wrap {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: var(--space-8);
    }
    .op-login-card {
      background: var(--color-bg-card); border: 1px solid var(--color-border);
      border-radius: var(--radius-2xl); padding: var(--space-12);
      max-width: 420px; width: 100%; text-align: center;
      box-shadow: var(--shadow-elevated);
    }
    .op-login-crab { margin-bottom: var(--space-6); }
    .op-login-crab img { opacity: 0.7; }
    .op-login-title { font-size: var(--text-xl); font-weight: 700; margin-bottom: var(--space-2); }
    .op-login-desc { font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8); line-height: var(--leading-relaxed); }
    .op-btn-x {
      display: inline-flex; align-items: center; justify-content: center; gap: var(--space-3);
      width: 100%; padding: var(--space-5) var(--space-8);
      background: var(--color-text-primary); color: var(--color-bg-deep);
      border-radius: var(--radius-pill); font-size: var(--text-base); font-weight: 600;
      font-family: var(--font-sans); border: none; cursor: pointer;
      text-decoration: none; transition: opacity var(--transition-fast);
    }
    .op-btn-x:hover { opacity: 0.9; }

    /* ---- Toast ---- */
    .op-toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(8px);
      display: flex; align-items: center; gap: var(--space-3);
      background: var(--color-bg-elevated); border: 1px solid var(--color-border);
      color: var(--color-text-primary);
      padding: var(--space-4) var(--space-8);
      border-radius: var(--radius-pill);
      font-size: var(--text-sm); font-weight: 500; font-family: var(--font-sans);
      z-index: 10000; opacity: 0;
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .op-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .op-toast-icon {
      width: 16px; height: 16px; border-radius: 50%;
      background: var(--color-success); color: var(--color-bg-deep);
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; flex-shrink: 0;
    }

    /* ---- Header user bubble ---- */
    .op-header-user {
      position: relative;
    }
    .op-header-bubble {
      display: flex; align-items: center; gap: var(--space-3);
      padding: var(--space-2) var(--space-4) var(--space-2) var(--space-2);
      background: var(--color-bg-card); border: 1px solid var(--color-border);
      border-radius: var(--radius-pill); cursor: pointer;
      transition: border-color var(--transition-fast);
    }
    .op-header-bubble:hover { border-color: var(--color-border-subtle); }
    .op-header-avatar {
      width: 24px; height: 24px; border-radius: 50%; overflow: hidden; flex-shrink: 0;
    }
    .op-header-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .op-header-username {
      font-size: var(--text-xs); font-weight: 500; color: var(--color-text-secondary);
    }
    .op-header-dropdown {
      display: none; position: absolute; top: calc(100% + 6px); right: 0;
      background: var(--color-bg-card); border: 1px solid var(--color-border);
      border-radius: var(--radius-lg); box-shadow: var(--shadow-elevated);
      min-width: 140px; padding: var(--space-2) 0; z-index: 100;
    }
    .op-header-user:hover .op-header-dropdown { display: block; }
    .op-header-dropdown-item {
      display: block; width: 100%; padding: var(--space-3) var(--space-6);
      background: none; border: none; text-align: left;
      font-size: var(--text-sm); font-weight: 500; font-family: var(--font-sans);
      color: var(--color-text-secondary); cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .op-header-dropdown-item:hover { background: var(--color-bg-elevated); color: var(--color-text-primary); }

    /* ---- Responsive ---- */
    @media (max-width: 768px) {
      .op-layout { flex-direction: column; }
      .op-detail-panel { width: 100%; border-left: none; border-top: 1px solid var(--color-border); max-height: 50vh; }
      .op-tbl-desc { max-width: 120px; }
    }
    @media (max-width: 640px) {
      .op-table th, .op-table td { padding: var(--space-4) var(--space-4); }
      .op-table th:first-child, .op-table td:first-child { padding-left: var(--space-8); }
      .op-table th:last-child, .op-table td:last-child { padding-right: var(--space-8); }
      .op-login-card { padding: var(--space-8); }
      .op-detail-header { padding: var(--space-6) var(--space-8); }
      .op-detail-section-title { padding-left: var(--space-8); padding-right: var(--space-8); }
      .op-app-card { padding-left: var(--space-8); padding-right: var(--space-8); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <a href="https://claw.tormund.io" style="display:flex;text-decoration:none;"><img src="/clawnads-logo-white.svg" alt="Clawnads"></a>
    </div>
    <div class="header-right" id="header-right"></div>
  </header>

  <!-- Tabs -->
  <nav class="tabs" id="tabs-nav" style="display:none;">
    <button class="tab active" data-tab="agents" onclick="switchTab('agents')">Agents</button>
    <button class="tab" data-tab="apps" onclick="switchTab('apps')">Apps</button>
  </nav>

  <!-- Main -->
  <div id="main" style="flex:1;display:flex;flex-direction:column;"></div>

  <script>
    const LOGIN_URL = '/developers/auth/login?redirect=' + encodeURIComponent('https://tormund.io/operator');
    // Sad crab SVG (inline, small)
    const SAD_CRAB = `<svg width="80" height="44" viewBox="0 0 100 55" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M31.2099 45.0527C31.3816 45.1109 31.3138 45.0772 31.455 45.1611C32.589 45.8338 33.9277 46.2766 35.1815 46.668C34.9152 47.0227 34.2144 47.7101 33.8407 48.1631C31.988 50.4053 31.1523 52.0517 30.078 54.6768C30.0466 54.7368 29.9425 54.8509 29.8944 54.9082C29.6623 55.008 29.5453 55.0327 29.3007 54.9521C26.7826 54.1202 26.2768 50.8331 27.1229 48.6533C27.8846 46.6925 29.4041 45.8487 31.2099 45.0527ZM68.4852 45.1162C69.0621 45.0313 70.4841 45.959 70.994 46.3555C73.2311 48.0924 73.9772 51.4654 72.1386 53.7686C71.8237 54.1626 70.946 54.9875 70.3876 54.9941C70.1555 54.9966 70.0611 54.9048 69.911 54.751C69.638 54.2115 69.4323 53.5146 69.1386 52.9385C67.8436 50.3981 66.7678 48.5855 64.6503 46.7012C65.9883 46.2882 67.3058 45.8796 68.4852 45.1162ZM75.0976 41.0518C77.6372 41.2724 79.9589 41.8337 81.8173 43.6602C84.0285 45.8334 84.4932 49.2289 82.1864 51.5244C81.7756 51.934 81.3041 52.3176 80.9091 51.668C80.7124 51.3342 80.2057 50.7078 79.9491 50.3447C77.9262 47.488 74.8661 44.6508 71.4413 43.6699C72.4779 43.2153 73.1779 42.6328 74.0526 41.916C74.4626 41.5805 74.6178 41.3382 75.0976 41.0518ZM24.953 41.1348C25.2018 41.3081 25.712 41.8073 25.994 42.043C26.8766 42.7798 27.5021 43.1421 28.5184 43.6533C25.1888 44.6816 22.494 46.9576 20.4198 49.7178C20.1465 50.0822 19.9759 50.3986 19.6708 50.7539L19.6093 50.8242C19.3237 51.0898 19.1644 51.66 18.7499 51.9531C18.4278 51.9673 18.1104 51.9103 17.8778 51.6797C14.6291 48.4648 16.6499 43.7235 20.4257 42.0674C21.7284 41.4963 22.1907 41.3268 23.6132 41.1611C24.0699 41.107 24.4952 41.1264 24.953 41.1348ZM50.412 21.7686C53.8394 21.7239 58.3896 22.4166 61.6933 23.4268C65.9905 24.9067 70.3972 27.0117 73.7499 30.1299C76.8457 33.0097 78.0987 34.494 74.744 37.8359C70.2383 42.3231 64.4548 44.3785 58.3495 45.5908C55.5323 46.1503 52.3726 46.1943 49.5321 46.1885C45.1317 46.1735 41.0227 45.7038 36.8075 44.4365C31.8682 42.951 25.0118 39.5832 23.1005 34.5C23.4202 32.8506 24.6728 31.4788 25.8983 30.3223C29.2819 27.1293 33.7394 24.8807 38.1278 23.4404C39.442 22.9808 40.9113 22.8445 42.2343 22.5049C45.0465 21.7828 47.5417 21.7667 50.412 21.7686ZM58.2714 36.7139C53.1801 33.6592 46.8197 33.6593 41.7284 36.7139C41.018 37.1401 40.7875 38.0621 41.2138 38.7725C41.6401 39.4825 42.5612 39.7122 43.2714 39.2861C47.4127 36.8014 52.5871 36.8013 56.7284 39.2861C57.4386 39.7122 58.3597 39.4825 58.786 38.7725C59.2122 38.0621 58.9817 37.1401 58.2714 36.7139ZM87.0839 0C92.2005 0.461954 97.6246 4.65656 99.1727 9.55762C99.4757 10.5174 100.012 12.7205 99.9999 13.7236C99.8876 22.8356 91.6694 29.0257 83.3222 30.3164C80.1773 30.8026 79.3214 31.1331 76.5575 29.6787C76.208 29.4223 75.9171 29.2185 75.747 28.8213C75.8109 28.4152 76.4329 28.1363 76.828 27.9307C78.3952 27.1126 79.3915 25.4821 80.5927 24.458C79.8025 23.6312 79.3988 22.8348 78.8427 21.8477C76.0729 16.926 76.379 9.33155 80.6288 5.25586C81.4663 7.83061 84.0478 12.8462 86.3554 14.2852C86.9364 14.1176 87.3281 12.3194 87.4335 11.7666C88.1696 7.90054 87.8807 3.83257 87.0839 0ZM12.5751 0.0224609C12.674 0.0188039 12.7036 0.0419007 12.8056 0.0742188C12.8109 0.105027 12.4873 2.15371 12.4237 2.41699C11.9339 4.44521 11.9777 13.3766 13.5809 14.2666C13.9333 14.0704 14.3942 13.5678 14.6747 13.2617C16.8563 10.8818 18.1966 8.25826 19.329 5.29004C20.1374 6.22699 21.0198 7.43298 21.5643 8.54297C24.0217 13.5521 22.9833 20.4614 19.1913 24.5205C20.1645 25.3207 20.9902 26.6263 22.1073 27.4258C22.6294 27.799 23.8926 28.3973 24.0468 28.7637C23.9779 29.0606 23.8152 29.1944 23.6112 29.4258C20.8948 31.2226 19.7045 30.7652 16.7216 30.3389C10.3594 29.4295 3.61264 25.3576 1.07411 19.2295C-2.55085 10.4783 3.42841 1.30598 12.5751 0.0224609ZM62.164 8.62793C65.1164 8.21829 67.8443 10.2775 68.2694 13.2363C68.6944 16.1954 66.6565 18.9439 63.7089 19.3867C60.7381 19.8328 57.9722 17.7685 57.5438 14.7861C57.1159 11.804 59.1885 9.04114 62.164 8.62793ZM36.1874 8.64844C39.1466 8.16434 41.9354 10.1844 42.4081 13.1543C42.8805 16.1242 40.8577 18.9139 37.8954 19.3779C34.9473 19.8393 32.1821 17.8218 31.7118 14.8662C31.2419 11.911 33.243 9.13068 36.1874 8.64844ZM37.0683 11.2412C35.6404 11.2416 34.4827 12.4037 34.4823 13.8359C34.4824 15.2683 35.6403 16.4303 37.0683 16.4307C38.4963 16.4305 39.655 15.2684 39.6552 13.8359C39.6548 12.4036 38.4962 11.2414 37.0683 11.2412ZM62.9306 11.2412C61.5023 11.2413 60.3447 12.4033 60.3446 13.8359C60.3448 15.2685 61.5024 16.4296 62.9306 16.4297C64.3588 16.4297 65.5164 15.2686 65.5165 13.8359C65.5165 12.4032 64.3589 11.2412 62.9306 11.2412Z" fill="white"/></svg>`;

    let allAgents = [];
    let selectedAgent = null;

    init();

    async function init() {
      try {
        const resp = await fetch('/developers/api/session');
        const session = await resp.json();
        if (session.authenticated) {
          renderHeaderUser(session);
          document.getElementById('tabs-nav').style.display = '';
          switchTab('agents');
          return;
        }
      } catch (e) {}
      renderLogin();
    }

    function renderHeaderUser(session) {
      const hr = document.getElementById('header-right');
      const avatarHtml = session.avatar
        ? `<div class="op-header-avatar"><img src="${esc(session.avatar)}" alt=""></div>`
        : '';
      hr.innerHTML = `<div class="op-header-user">
        <div class="op-header-bubble">
          ${avatarHtml}
          <span class="op-header-username">@${esc(session.username)}</span>
        </div>
        <div class="op-header-dropdown">
          <button class="op-header-dropdown-item" onclick="logout()">Sign out</button>
        </div>
      </div>`;
    }

    async function logout() {
      try { await fetch('/developers/auth/logout', { method: 'POST' }); } catch (e) {}
      window.location.reload();
    }

    function switchTab(tab) {
      document.querySelectorAll('#tabs-nav .tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      if (tab === 'agents') loadAgentsTab();
      else if (tab === 'apps') loadAppsTab();
    }

    function renderLogin() {
      document.getElementById('main').innerHTML = `
        <div class="op-login-wrap">
          <div class="op-login-card">
            <div class="op-login-crab"><img src="/happy-crab-blue.svg" alt="" width="48" height="48"></div>
            <div class="op-login-title">Operator Portal</div>
            <div class="op-login-desc">Sign in to manage your agents and connected apps</div>
            <a href="${LOGIN_URL}" class="op-btn-x">
              <svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              Sign in with X
            </a>
          </div>
        </div>
      `;
    }

    // ==================== AGENTS TAB ====================
    async function loadAgentsTab() {
      const main = document.getElementById('main');
      main.innerHTML = `<div class="op-layout">
        <div class="op-list-panel"><div style="padding:var(--space-10) var(--space-16);color:var(--color-text-muted);font-size:var(--text-sm);">Loading...</div></div>
        <div class="op-detail-panel" id="detail-panel">
          <div class="op-select-prompt">
            <div class="op-select-prompt-crab">${SAD_CRAB}</div>
            <div class="op-select-prompt-text">Select an agent</div>
          </div>
        </div>
      </div>`;

      try {
        const resp = await fetch('/operator/api/agents');
        if (resp.status === 401) return renderLogin();
        const data = await resp.json();
        allAgents = data.agents || [];
        renderAgentTable();
        // Auto-select first agent
        if (allAgents.length > 0) selectAgent(allAgents[0].name);
      } catch (e) {
        document.querySelector('.op-list-panel').innerHTML = `<div style="padding:var(--space-10) var(--space-16);color:var(--color-text-muted);font-size:var(--text-sm);">Failed to load</div>`;
      }
    }

    function renderAgentTable() {
      const panel = document.querySelector('.op-list-panel');
      if (!allAgents.length) {
        panel.innerHTML = `<div class="op-empty"><div class="op-empty-crab">${SAD_CRAB}</div><div class="op-empty-text">No claimed agents yet.<br>Claim an agent from their profile to manage it here.</div></div>`;
        return;
      }

      let rows = '';
      for (const agent of allAgents) {
        const avatarHtml = agent.avatarUrl
          ? `<img src="${esc(agent.avatarUrl)}" alt="">`
          : esc((agent.name || '?')[0].toUpperCase());
        const walletShort = agent.wallet ? agent.wallet.slice(0, 6) + '\u2026' + agent.wallet.slice(-4) : '';
        const isOnline = agent.lastSeen && (Date.now() - new Date(agent.lastSeen).getTime()) < 3600000;
        const appCount = (agent.connectedApps || []).length;
        const activeApps = (agent.connectedApps || []).filter(a => !a.revoked).length;

        rows += `<tr data-agent="${esc(agent.name)}" onclick="selectAgent('${esc(agent.name)}')" class="${selectedAgent === agent.name ? 'selected' : ''}">
          <td>
            <div class="op-name-cell">
              <div class="op-tbl-avatar">${avatarHtml}</div>
              <div>
                <div class="op-tbl-name">${esc(agent.name)}</div>
                ${agent.description ? `<div class="op-tbl-desc">${esc(agent.description)}</div>` : ''}
              </div>
            </div>
          </td>
          <td><span class="op-tbl-wallet">${walletShort}</span></td>
          <td><span class="op-tbl-apps">${activeApps > 0 ? activeApps + ' app' + (activeApps > 1 ? 's' : '') : 'None'}</span></td>
          <td>
            <span class="op-tbl-status">
              <span class="op-dot ${isOnline ? 'online' : 'offline'}"></span>
              ${isOnline ? 'Online' : timeAgo(agent.lastSeen)}
            </span>
          </td>
        </tr>`;
      }

      panel.innerHTML = `<table class="op-table">
        <thead><tr>
          <th>Agent</th>
          <th>Address</th>
          <th>Apps</th>
          <th style="text-align:right;">Status</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    function selectAgent(name) {
      selectedAgent = name;
      // Update row selection
      document.querySelectorAll('.op-table tbody tr').forEach(tr => {
        tr.classList.toggle('selected', tr.dataset.agent === name);
      });
      // Render detail panel
      const agent = allAgents.find(a => a.name === name);
      if (!agent) return;
      renderDetailPanel(agent);
    }

    const SCOPE_INFO = {
      balance: { label: 'Balance', desc: 'View wallet balance', access: 'ro' },
      swap: { label: 'Swap', desc: 'Swap tokens within daily cap', access: 'rw' },
      send: { label: 'Send', desc: 'Send tokens within daily cap', access: 'rw' },
      sign: { label: 'Sign', desc: 'Sign messages', access: 'rw' },
      messages: { label: 'Messages', desc: 'Read and send messages', access: 'rw' },
      profile: { label: 'Profile', desc: 'View agent profile', access: 'ro' },
    };

    function formatFullDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) +
        ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    }

    function renderDetailPanel(agent) {
      const panel = document.getElementById('detail-panel');
      const apps = agent.connectedApps || [];

      let appsHtml = '';
      if (apps.length === 0) {
        appsHtml = `<div class="op-empty">
          <div class="op-empty-crab">${SAD_CRAB}</div>
          <div class="op-empty-text">No connected apps</div>
        </div>`;
      } else {
        for (const app of apps) {
          const iconHtml = app.iconUrl
            ? `<img src="${esc(app.iconUrl)}" alt="">`
            : `<img src="/default-dapp-icon.svg" alt="" style="width:100%;height:100%;padding:2px;opacity:0.5;">`;
          const ago = timeAgo(app.approvedAt);
          const scopeCount = app.scopes.length;
          const scopePreview = scopeCount <= 3 ? app.scopes.join(', ') : app.scopes.slice(0, 2).join(', ') + ` +${scopeCount - 2}`;

          // Scope detail rows
          let scopeRows = '';
          for (const s of app.scopes) {
            const info = SCOPE_INFO[s] || { label: s, desc: s, access: 'ro' };
            scopeRows += `<div class="op-scope-row">
              <span class="op-scope-dot ${info.access}"></span>
              <span class="op-scope-name">${esc(info.label)}</span>
              <span class="op-scope-access-badge ${info.access}">${info.access === 'rw' ? 'Read & write' : 'Read only'}</span>
            </div>`;
          }

          const revokeOrBadge = app.revoked
            ? `<span class="op-revoked-badge">Revoked</span>`
            : `<button class="op-btn-revoke" onclick="event.stopPropagation(); revokeApp('${esc(agent.name)}','${esc(app.clientId)}',this)">Revoke app permissions</button>`;

          const statusDot = app.revoked ? '' : '<span class="op-app-status-dot"></span>';

          appsHtml += `<div class="op-app-card${app.revoked ? ' revoked' : ''}" onclick="this.classList.toggle('expanded')">
            <div class="op-app-card-row">
              <div class="op-app-icon">${iconHtml}</div>
              <div class="op-app-info">
                <div class="op-app-name">${esc(app.name)}${statusDot}</div>
                <div class="op-app-scopes-preview">${esc(scopePreview)}</div>
              </div>
              <svg class="op-app-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="op-app-detail" onclick="event.stopPropagation()">
              ${app.description ? `<div class="op-app-detail-desc">${esc(app.description)}</div>` : ''}
              <div class="op-app-detail-section">
                <div class="op-app-detail-label">Approved</div>
                <div class="op-app-detail-date">${formatFullDate(app.approvedAt)}</div>
              </div>
              <div class="op-app-detail-section">
                <div class="op-app-detail-label">Permissions</div>
                <div class="op-scope-list">${scopeRows}</div>
              </div>
              ${revokeOrBadge}
            </div>
          </div>`;
        }
      }

      panel.innerHTML = `
        <div class="op-detail-body">
          <div class="op-detail-section-title">Connected Apps</div>
          ${appsHtml}
        </div>
      `;
    }

    async function revokeApp(agentName, clientId, btn) {
      btn.disabled = true;
      btn.textContent = 'Revoking...';
      try {
        const resp = await fetch('/operator/api/revoke', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ agentName, clientId })
        });
        if (resp.status === 401) return renderLogin();
        const data = await resp.json();
        if (data.success) {
          // Update local data
          const agent = allAgents.find(a => a.name === agentName);
          if (agent) {
            const app = (agent.connectedApps || []).find(a => a.clientId === clientId);
            if (app) app.revoked = true;
            renderDetailPanel(agent);
            renderAgentTable(); // update app count
          }
          showToast('Access revoked');
        } else {
          btn.disabled = false; btn.textContent = 'Revoke';
          showToast(data.error || 'Failed');
        }
      } catch (e) {
        btn.disabled = false; btn.textContent = 'Revoke';
        showToast('Network error');
      }
    }

    // ==================== APPS TAB (universal revoke) ====================
    async function loadAppsTab() {
      const main = document.getElementById('main');
      main.innerHTML = `<div style="flex:1;display:flex;flex-direction:column;align-items:center;padding:var(--space-10) var(--space-16);">
        <div style="max-width:560px;width:100%;"><div id="apps-list" style="color:var(--color-text-muted);font-size:var(--text-sm);">Loading...</div></div>
      </div>`;

      try {
        const resp = await fetch('/operator/api/connected-apps');
        if (resp.status === 401) return renderLogin();
        const data = await resp.json();
        renderAppsList(data.apps);
      } catch (e) {
        document.getElementById('apps-list').textContent = 'Failed to load';
      }
    }

    function renderAppsList(apps) {
      const container = document.getElementById('apps-list');
      if (!apps || apps.length === 0) {
        container.innerHTML = `<div class="op-empty"><div class="op-empty-crab">${SAD_CRAB}</div><div class="op-empty-text">No apps connected yet.<br>Apps appear here when you approve OAuth access.</div></div>`;
        return;
      }

      // Group by agent
      const grouped = {};
      for (const app of apps) {
        if (!grouped[app.agentName]) grouped[app.agentName] = { avatar: app.agentAvatar, apps: [] };
        grouped[app.agentName].apps.push(app);
      }

      let html = '';
      for (const [agentName, group] of Object.entries(grouped)) {
        const avatarHtml = group.avatar
          ? `<img src="${esc(group.avatar)}" alt="">`
          : esc(agentName[0].toUpperCase());

        html += `<div style="margin-bottom:var(--space-10);">
          <div style="display:flex;align-items:center;gap:var(--space-3);margin-bottom:var(--space-4);">
            <div class="op-tbl-avatar" style="width:24px;height:24px;font-size:10px;">${avatarHtml}</div>
            <span style="font-size:var(--text-sm);font-weight:600;color:var(--color-text-secondary);">${esc(agentName)}</span>
          </div>`;

        for (const app of group.apps) {
          const iconHtml = app.iconUrl
            ? `<img src="${esc(app.iconUrl)}" alt="">`
            : `<img src="/default-dapp-icon.svg" alt="" style="width:100%;height:100%;padding:2px;opacity:0.5;">`;
          const ago = timeAgo(app.approvedAt);
          const scopeCount = app.scopes.length;
          const scopePreview = scopeCount <= 3 ? app.scopes.join(', ') : app.scopes.slice(0, 2).join(', ') + ` +${scopeCount - 2}`;

          let scopeRows = '';
          for (const s of app.scopes) {
            const info = SCOPE_INFO[s] || { label: s, desc: s, access: 'ro' };
            scopeRows += `<div class="op-scope-row">
              <span class="op-scope-dot ${info.access}"></span>
              <span class="op-scope-name">${esc(info.label)}</span>
              <span class="op-scope-access-badge ${info.access}">${info.access === 'rw' ? 'Read & write' : 'Read only'}</span>
            </div>`;
          }

          const revokeOrBadge = app.revoked
            ? `<span class="op-revoked-badge">Revoked</span>`
            : `<button class="op-btn-revoke" onclick="event.stopPropagation(); revokeAppGlobal('${esc(app.agentName)}','${esc(app.clientId)}',this)">Revoke app permissions</button>`;

          const globalStatusDot = app.revoked ? '' : '<span class="op-app-status-dot"></span>';

          html += `<div class="op-app-card${app.revoked ? ' revoked' : ''}" style="padding:var(--space-4) var(--space-6);background:var(--color-bg-card);border:1px solid var(--color-border);border-radius:var(--radius-lg);margin-bottom:var(--space-3);" onclick="this.classList.toggle('expanded')">
            <div class="op-app-card-row">
              <div class="op-app-icon">${iconHtml}</div>
              <div class="op-app-info">
                <div class="op-app-name">${esc(app.name)}${globalStatusDot}</div>
                <div class="op-app-scopes-preview">${esc(scopePreview)}</div>
              </div>
              <svg class="op-app-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="op-app-detail" onclick="event.stopPropagation()" style="padding-left:36px;">
              ${app.description ? `<div class="op-app-detail-desc">${esc(app.description)}</div>` : ''}
              <div class="op-app-detail-section">
                <div class="op-app-detail-label">Approved</div>
                <div class="op-app-detail-date">${formatFullDate(app.approvedAt)}</div>
              </div>
              <div class="op-app-detail-section">
                <div class="op-app-detail-label">Permissions</div>
                <div class="op-scope-list">${scopeRows}</div>
              </div>
              ${revokeOrBadge}
            </div>
          </div>`;
        }
        html += `</div>`;
      }
      container.innerHTML = html;
    }

    async function revokeAppGlobal(agentName, clientId, btn) {
      btn.disabled = true; btn.textContent = 'Revoking...';
      try {
        const resp = await fetch('/operator/api/revoke', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ agentName, clientId })
        });
        if (resp.status === 401) return renderLogin();
        const data = await resp.json();
        if (data.success) {
          btn.replaceWith(Object.assign(document.createElement('span'), { className: 'op-revoked', textContent: 'Revoked' }));
          showToast('Access revoked');
        } else { btn.disabled = false; btn.textContent = 'Revoke'; showToast(data.error || 'Failed'); }
      } catch (e) { btn.disabled = false; btn.textContent = 'Revoke'; showToast('Network error'); }
    }

    // ==================== UTILS ====================
    function showToast(msg) {
      let toast = document.getElementById('op-toast');
      if (!toast) { toast = document.createElement('div'); toast.id = 'op-toast'; toast.className = 'op-toast'; document.body.appendChild(toast); }
      toast.innerHTML = `<span class="op-toast-icon">\u2713</span>${esc(msg)}`;
      toast.classList.remove('show'); void toast.offsetWidth; toast.classList.add('show');
      clearTimeout(toast._t); toast._t = setTimeout(() => toast.classList.remove('show'), 2500);
    }

    function timeAgo(iso) {
      if (!iso) return '';
      const diff = Date.now() - new Date(iso).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return `${mins}m ago`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 30) return `${days}d ago`;
      return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function esc(str) { const d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }
  </script>
</body>
</html>
